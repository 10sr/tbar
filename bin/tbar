#!/usr/bin/env python3

import sys

def add_path():
    from os.path import normpath, join, exists, dirname, abspath, realpath
    libdir = normpath(join(dirname(realpath(__file__)), ".."))
    if exists(join(libdir, "tbar")):
        sys.path.insert(0, libdir)
    # sys.argv[0] = os.path.abspath(__file__)
    return

def main(argv):
    import argparse as ap

    import tbar

    parser = ap.ArgumentParser("tbar")
    parser.add_argument("filename",
                        help="filename for input. If omitted read from stdin",
                        nargs="?", default=None)

    # TODO: add arguments for reader
    parser.add_argument("-r", "--regexp",
                        help="regular expression to extract key and value. \
                        When this option is given, -s and -f options are \
                        ignored",
                        default=None)
    parser.add_argument("-c", "--comment",
                        help="string that leading commnent strings",
                        default="#")
    parser.add_argument("-s", "--sep",
                        help="separator of field",
                        default=" ")
    parser.add_argument("-f", "--field",
                        help="number of field to use. FIELD must be in the \
                        form like \"NUM,NUM\", where the first one is key and \
                        the second is value",
                        default="1,2")

    parser.add_argument("-m", "--max", help="value for max",
                        type=float, default=0)
    parser.add_argument("-l", "--length", help="length of bars, default to 50",
                        type=int, default=50)
    parser.add_argument("-v", "--vertical", help="print bars vertically",
                        action="store_true", default=False)

    args = parser.parse_args(argv[1:])

    main_args = dict()
    for a in "comment", "sep", "max", "length", "regexp", "vertical":
        main_args[a] = getattr(args, a)

    main_args["field"] = tuple(int(n) for n in args.field.split(","))

    if args.filename:
        with open(args.filename) as f:
            tbar.main(infile=f, **main_args)
    else:
        tbar.main(infile=sys.stdin, **main_args)

    return

if __name__ == "__main__":
    add_path()
    main(sys.argv)
